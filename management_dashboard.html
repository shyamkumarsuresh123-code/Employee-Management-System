<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Dashboard - AI Infotech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- General Reset --- */
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100%; background-color: #f4f6f9; }
        .wrapper { display: flex; height: 100vh; width: 100%; }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background-color: #212529; color: #ffffff; display: flex; flex-direction: column; flex-shrink: 0; height: 100vh; }
        .brand-logo { padding: 20px; text-align: center; background-color: #1a1e21; border-bottom: 1px solid #32383e; border-left: 5px solid #ffc107; }
        .sidebar-logo { max-width: 100%; height: auto; width: 180px; display: block; margin: 0 auto; }
        
        .nav-links { list-style: none; padding: 0; margin: 20px 0; flex-grow: 1; overflow-y: auto; }
        .nav-links li a, .nav-links summary { display: block; padding: 15px 20px; color: #adb5bd; text-decoration: none; transition: 0.3s; cursor: pointer; font-size: 1rem; }
        .nav-links li a:hover, .nav-links summary:hover, .nav-links li a.active-link { background-color: #ffc107; color: #212529; font-weight: 600; }
        .nav-links i { width: 25px; text-align: center; margin-right: 10px; }
        
        details summary { list-style: none; outline: none; }
        details summary::after { content: '\25BC'; float: right; font-size: 0.8em; margin-top: 5px; }
        details[open] summary::after { content: '\25B2'; }
        .sub-menu { background-color: #32383e; padding-left: 0; margin: 0; list-style: none; }
        .sub-menu a { padding-left: 55px !important; font-size: 0.9rem; border-left: 3px solid transparent; }
        .sub-menu a:hover { border-left-color: #ffc107; }

        .sidebar-footer { padding: 20px; border-top: 1px solid #32383e; background-color: #1a1e21; }
        .btn-logout { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px 0; background-color: transparent; color: #dc3545; border: 1px solid #dc3545; border-radius: 5px; text-decoration: none; font-weight: bold; transition: 0.3s; }
        .btn-logout:hover { background-color: #dc3545; color: white; }

        /* --- MAIN CONTENT --- */
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .dashboard-top-bar { background-color: white; padding: 20px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #ffc107; }
        .welcome-msg h2 { margin: 0; font-size: 1.4rem; color: #333; }
        .welcome-msg p { margin: 5px 0 0 0; color: #666; font-size: 0.95rem; }
        .date-widget { background-color: #fff9db; padding: 10px 20px; border-radius: 50px; border: 1px solid #ffeeba; display: flex; align-items: center; color: #856404; font-weight: 600; }
        .date-widget i { color: #d39e00; margin-right: 10px; }

        .content-container { padding: 30px; }
        .section-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid #ffc107; text-align: center; }
        .stat-card h4 { margin: 0; color: #666; font-size: 1rem; text-transform: uppercase; }
        .stat-card .count { font-size: 2.5rem; margin: 10px 0; color: #333; font-weight: bold; }
        
        .btn-view-more { background-color: #ffc107; color: #212529; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: background 0.2s; }
        .btn-view-more:hover { background-color: #e0a800; }

        /* Lists & Tables */
        .two-col-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .list-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .list-box h4 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .report-table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .styled-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .styled-table thead tr { background-color: #f8f9fa; text-align: left; }
        .styled-table th, .styled-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .styled-table tbody tr:hover { background-color: #fff9db; }

        /* Report Cards */
        .report-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px; }
        .report-card { background: #fff; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .report-card h5 { margin: 0; color: #666; }
        .report-card p { font-size: 1.5rem; font-weight: bold; color: #333; margin: 10px 0; }

        /* Requests */
        .req-card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ffc107; }
        .req-info h5 { margin: 0 0 5px 0; font-size: 1.1rem; color: #333; }
        .req-info p { margin: 0; color: #666; font-size: 0.95rem; }
        .req-reason { font-size: 0.85rem; color: #888; margin-top: 5px; font-style: italic; }
        .action-btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-left: 5px; font-weight: bold;}
        .btn-approve { background-color: #28a745; }
        .btn-deny { background-color: #dc3545; }
        .btn-approve:hover { background-color: #218838; }
        .btn-deny:hover { background-color: #c82333; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 50%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; border-top: 5px solid #ffc107; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; }
        
        .data-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .data-list li { padding: 10px 0; border-bottom: 1px solid #f1f1f1; display: flex; align-items: center; }
        .avatar { width: 35px; height: 35px; background-color: #fff3cd; color: #856404; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }

        /* Calendar */
        .agenda-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .calendar-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .calendar-nav button { background: #fff3cd; border: 1px solid #ffeeba; padding: 5px 15px; cursor: pointer; border-radius: 4px; color: #856404; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; text-align: center; }
        .day-name { font-weight: bold; color: #555; padding: 10px 0; }
        
        .calendar-day { height: 100px; border: 1px solid #eee; padding: 5px; position: relative; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; }
        .calendar-day:hover { background-color: #fff9db; border-color: #ffc107; }
        .calendar-day.current-day { background-color: #fff3cd; border: 1px solid #ffc107; }
        
        /* Event Badges - Clickable */
        .event-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; margin-bottom: 3px; width: 90%; text-align: left; font-weight: bold; color: white; cursor: pointer; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 10; }
        .event-badge:hover { opacity: 0.9; transform: scale(1.02); }
        .badge-meeting { background-color: #007bff; }
        .badge-urgent { background-color: #dc3545; }
        .badge-holiday { background-color: #28a745; }
        .badge-default { background-color: #ffc107; color: black; }

        /* Forms */
        .form-card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; border-top: 3px solid #ffc107; }
        .form-group { margin-bottom: 20px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn-submit { background-color: #ffc107; color: #212529; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-submit.urgent { background-color: #dc3545; color: white;}
        .btn-delete { background-color: #dc3545; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; display: none; }
        
        /* Utility */
        .spinner { font-size: 2rem; color: #ffc107; text-align: center; display: block; margin: 20px auto; }
        #noRequestsMsg { text-align: center; color: #888; font-style: italic; display: none; }
    </style>
</head>
<body>

<div class="wrapper">

    <aside class="sidebar">
        <div class="brand-logo"><img src="aiinfo.webp" alt="AI Infotech Logo" class="sidebar-logo"></div>
        <ul class="nav-links">
            <li><a onclick="showSection('dashboard')" class="active-link"><i class="fa-solid fa-gauge"></i> Dashboard</a></li>
            <li><a onclick="showSection('agenda')"><i class="fa-solid fa-calendar-days"></i> Agenda</a></li>
            
            <li><a onclick="showSection('employee-details')"><i class="fa-solid fa-users-gear"></i> Employee Details</a></li>

            <li><a onclick="showSection('emp-requests')"><i class="fa-solid fa-envelope-open-text"></i> Employees Request</a></li>
            
            <li>
                <details open>
                    <summary><i class="fa-solid fa-clipboard-user"></i> Attendance</summary>
                    <ul class="sub-menu">
                        <li><a onclick="showSection('attendance-overview')">Overview</a></li>
                        <li><a onclick="showSection('attendance-sheet')">Employee Attendance DB</a></li>
                    </ul>
                </details>
            </li>

            <li>
                <details>
                    <summary><i class="fa-solid fa-bullhorn"></i> Announcements</summary>
                    <ul class="sub-menu">
                        <li><a onclick="showSection('announce-general')">General Announcement</a></li>
                        <li><a onclick="showSection('announce-urgent')">Urgent Announcement</a></li>
                    </ul>
                </details>
            </li>
        </ul>
        <div class="sidebar-footer"><a href="index.html" class="btn-logout"><i class="fa-solid fa-power-off"></i> &nbsp; Logout</a></div>
    </aside>

    <main class="main-content">
        <div class="dashboard-top-bar">
            <div class="welcome-msg"><h2>Welcome, <strong>Admin</strong></h2><p>Management Portal</p></div>
            <div class="date-widget"><i class="fa-regular fa-calendar"></i> <span id="currentDate">Loading...</span></div>
        </div>

        <div class="content-container">
            <div id="dashboard" class="section-view active">
                <h3>Dashboard Overview</h3><br>
                <div class="dashboard-grid">
                    <div class="stat-card"><h4>Total Employees</h4><div class="count">124</div><button class="btn-view-more" onclick="openModal('modal-employees')">View More</button></div>
                    <div class="stat-card"><h4>Today's Absentees</h4><div class="count" style="color: #dc3545;">4</div><button class="btn-view-more" onclick="openModal('modal-absentees')">View More</button></div>
                    <div class="stat-card"><h4>Pending Requests</h4><div class="count" style="color: #d39e00;">8</div><button class="btn-view-more" onclick="showSection('emp-requests')">View More</button></div>
                </div>
            </div>

            <div id="agenda" class="section-view">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Team Agenda</h3>
                    <button class="btn-view-more" onclick="fetchSheetEvents()">Refresh Calendar</button>
                </div>
                <p style="color:#666;">Click any date to add a new event. Click a label to edit/remove.</p>
                <div class="agenda-card">
                    <div class="calendar-header">
                        <h2 id="monthYearDisplay">Month Year</h2>
                        <div class="calendar-nav">
                            <button onclick="changeMonth(-1)">Prev</button>
                            <button onclick="changeMonth(1)">Next</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                    <p style="text-align: center; color: #666; margin-top:10px;"><small id="calLoading" style="display:none;">Syncing...</small></p>
                </div>
            </div>

            <div id="employee-details" class="section-view">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Employee Directory (All Staff)</h3>
                    <button class="btn-view-more" onclick="downloadEmployeeExcel()"><i class="fa-solid fa-file-excel"></i> Download Excel</button>
                </div>
                <p style="color: #666; margin-bottom: 20px;">Fetching data from User Registration Database...</p>
                <div class="report-table-container">
                    <i id="empSpinner" class="fa-solid fa-spinner fa-spin spinner"></i>
                    <table class="styled-table" id="empTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>User Name (ID)</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Date Of Birth</th>
                                <th>Role</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="empBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="emp-requests" class="section-view">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h3>Pending Employee Requests</h3>
                    <button class="btn-view-more" onclick="fetchRequests()">Refresh</button>
                </div>
                <br>
                <div id="requestsContainer">
                    <i id="reqSpinner" class="fa-solid fa-spinner fa-spin spinner"></i>
                    </div>
                <p id="noRequestsMsg">No pending requests.</p>
            </div>

            <div id="attendance-overview" class="section-view">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Attendance Overview</h3>
                    <button class="btn-view-more" id="toggleReportBtn" onclick="toggleAttendanceView()">View Reports</button>
                </div>
                <br>
                <div id="attendance-daily">
                    <div class="two-col-grid">
                        <div class="list-box"><h4 style="color: #28a745;">Present Today (120)</h4><ul class="data-list"><li><span class="avatar">JD</span> John Doe</li></ul></div>
                        <div class="list-box"><h4 style="color: #dc3545;">On Leave (4)</h4><ul class="data-list"><li><span class="avatar" style="background:#f8d7da; color:#721c24;">MW</span> Mark Williams</li></ul></div>
                    </div>
                </div>
                <div id="attendance-reports" style="display: none;">
                    <h4>Statistical Reports</h4>
                    <div class="report-grid">
                        <div class="report-card"><h5>Weekly Attendance</h5><p>98%</p></div>
                        <div class="report-card"><h5>Monthly Attendance</h5><p>95%</p></div>
                    </div>
                </div>
            </div>

            <div id="attendance-sheet" class="section-view">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Employee Attendance Sheet (Live)</h3>
                    <button class="btn-view-more" onclick="downloadAttendanceExcel()"><i class="fa-solid fa-file-excel"></i> Download Excel</button>
                </div>
                <p style="color: #666; margin-bottom: 20px;">Fetching data from SheetDB...</p>
                <div class="report-table-container">
                    <i id="sheetSpinner" class="fa-solid fa-spinner fa-spin spinner"></i>
                    <table class="styled-table" id="sheetTable" style="display: none;">
                        <thead><tr><th>Name</th><th>Date</th><th>In Time</th><th>Out Time</th><th>Working Period</th><th>Action</th></tr></thead>
                        <tbody id="sheetBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="announce-general" class="section-view"><h3>Create General Announcement</h3><div class="form-card"><div class="form-group"><textarea class="form-control" rows="4"></textarea></div><button class="btn-submit">Post</button></div></div>
            <div id="announce-urgent" class="section-view"><h3 style="color: #dc3545;">Create Urgent Announcement</h3><div class="form-card" style="border-top: 5px solid #dc3545;"><div class="form-group"><textarea class="form-control" rows="4"></textarea></div><button class="btn-submit urgent">Post</button></div></div>
        </div>
    </main>
</div>

<div id="modal-employees" class="modal-overlay"><div class="modal-content"><span class="close-btn" onclick="closeModal('modal-employees')">&times;</span><h3>Employee Directory</h3><ul class="data-list"><li><span class="avatar">JD</span> John Doe</li></ul></div></div>
<div id="modal-absentees" class="modal-overlay"><div class="modal-content"><span class="close-btn" onclick="closeModal('modal-absentees')">&times;</span><h3 style="color:#dc3545">Absent Today</h3><ul class="data-list"><li><span class="avatar" style="background:#f8d7da; color:#721c24;">MW</span> Mark Williams</li></ul></div></div>

<div id="modal-add-event" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h3 id="modalEventHeader">Manage Event</h3><span class="close-btn" onclick="closeModal('modal-add-event')">&times;</span></div>
        <div class="form-group"><label>Date</label><input type="text" id="eventDate" class="form-control" readonly></div>
        <div class="form-group"><label>Event Name</label><input type="text" id="eventTitle" class="form-control"></div>
        <div class="form-group"><label>Label Color</label>
            <select id="eventType" class="form-control">
                <option value="badge-default">General (Yellow)</option>
                <option value="badge-meeting">Meeting (Blue)</option>
                <option value="badge-urgent">Urgent (Red)</option>
                <option value="badge-holiday">Holiday (Green)</option>
            </select>
        </div>
        <input type="hidden" id="sheetEventId">
        <div style="display: flex; justify-content: flex-end;">
            <button id="btnSaveEvent" class="btn-submit" onclick="saveEvent()">Save</button>
            <button class="btn-delete" id="btnDeleteEvent" onclick="deleteEvent()">Delete</button>
        </div>
    </div>
</div>

<div id="modal-deny-req" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h3 style="color:#dc3545">Deny Request</h3><span class="close-btn" onclick="closeModal('modal-deny-req')">&times;</span></div>
        <div class="form-group">
            <label>Reason for Denial:</label>
            <textarea id="denyReason" class="form-control" rows="4" placeholder="e.g. Insufficient leave balance"></textarea>
        </div>
        <button class="btn-submit" style="background-color:#dc3545; color:white; width:100%;" onclick="submitDeny()">Confirm Denial</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    const ATTENDANCE_API = "https://sheetdb.io/api/v1/arh117tr3hvvy";
    let EVENTS_API = "https://sheetdb.io/api/v1/ixqhkw8b3j8e6"; 
    if(EVENTS_API.endsWith('/')) EVENTS_API = EVENTS_API.slice(0, -1);
    const REQUESTS_API = "https://sheetdb.io/api/v1/we2frfscvur6g";
    const USER_DB_API = "https://sheetdb.io/api/v1/b53909p8ngawe";

    // --- 1. Navigation ---
    function showSection(sectionId) {
        document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active-link'));
        
        if(sectionId === 'attendance-sheet') loadSheetData();
        if(sectionId === 'agenda') fetchSheetEvents();
        if(sectionId === 'emp-requests') fetchRequests();
        if(sectionId === 'employee-details') fetchEmployeeDetails(); 
    }

    document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

    // --- 2. DATE FIX FUNCTION ---
    function formatSheetDate(dateVal) {
        if (!isNaN(dateVal) && dateVal > 20000) {
            const date = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
            return date.toLocaleDateString('en-GB'); 
        }
        return dateVal; 
    }

    // --- 3. Attendance Toggle ---
    let isReportView = false;
    function toggleAttendanceView() {
        const daily = document.getElementById('attendance-daily');
        const reports = document.getElementById('attendance-reports');
        const btn = document.getElementById('toggleReportBtn');
        isReportView = !isReportView;
        if(isReportView) {
            daily.style.display = 'none'; reports.style.display = 'block'; btn.innerText = "Back to List";
        } else {
            daily.style.display = 'block'; reports.style.display = 'none'; btn.innerText = "View Reports";
        }
    }

    // --- 4. SheetDB Attendance Data ---
    function loadSheetData() {
        const table = document.getElementById('sheetTable');
        const tbody = document.getElementById('sheetBody');
        const spinner = document.getElementById('sheetSpinner');
        table.style.display = 'none'; spinner.style.display = 'block'; tbody.innerHTML = '';

        fetch(ATTENDANCE_API).then(res => res.json()).then(data => {
            spinner.style.display = 'none'; table.style.display = 'table';
            data.forEach(row => {
                const empName = row["Employee Name"] ? row["Employee Name"] : "Unknown";
                if(row.Date || row.InTime) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${empName}</td><td>${row.Date||'-'}</td><td>${row.InTime||'-'}</td><td>${row.OutTime||'-'}</td><td>${row.WorkingPeriod||'-'}</td><td><span class="event-badge badge-default" style="color:black">${row.Action||'-'}</span></td>`;
                    tbody.appendChild(tr);
                }
            });
        }).catch(e => { spinner.style.display = 'none'; tbody.innerHTML = '<tr><td colspan="6" style="color:red;text-align:center">Error loading data.</td></tr>'; table.style.display = 'table'; });
    }

    // --- 5. EXCEL DOWNLOAD FUNCTIONS (USING SHEETJS) ---
    
    // Generic function to export a Table ID to Excel
    function exportTableToExcel(tableId, filename) {
        var table = document.getElementById(tableId);
        // Check if table has data (rows > 1 because row 0 is header)
        if (!table || table.rows.length <= 1) { 
            alert("No data available to download!"); 
            return; 
        }
        
        // Convert table to worksheet
        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.table_to_sheet(table);
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        
        // Save file
        XLSX.writeFile(wb, filename);
    }

    function downloadAttendanceExcel() {
        exportTableToExcel('sheetTable', 'attendance_report.xlsx');
    }

    function downloadEmployeeExcel() {
        exportTableToExcel('empTable', 'employee_directory.xlsx');
    }

    // --- 6. FETCH EMPLOYEE DETAILS ---
    function fetchEmployeeDetails() {
        const table = document.getElementById('empTable');
        const tbody = document.getElementById('empBody');
        const spinner = document.getElementById('empSpinner');
        
        table.style.display = 'none';
        spinner.style.display = 'block';
        tbody.innerHTML = '';

        fetch(USER_DB_API)
            .then(res => res.json())
            .then(data => {
                spinner.style.display = 'none';
                table.style.display = 'table';
                
                data.forEach(user => {
                    const tr = document.createElement('tr');
                    const fullName = `${user['First Name'] || ''} ${user['Last Name'] || ''}`;
                    const rawDob = user['Date Of Birth'];
                    const formattedDob = formatSheetDate(rawDob); 

                    const role = user['role'] || 'Employee'; 
                    const status = user['status'] || 'Active'; 

                    tr.innerHTML = `
                        <td>${user['User Name'] || '-'}</td>
                        <td>${fullName}</td>
                        <td>${user['Email'] || '-'}</td>
                        <td>${user['Phone Number'] || '-'}</td>
                        <td>${formattedDob}</td>
                        <td>${role}</td>
                        <td><span class="badge bg-Approved">${status}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                spinner.style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="7" style="color:red; text-align:center">Failed to load employee data.</td></tr>';
                table.style.display = 'table';
                console.error(err);
            });
    }

    // --- 7. CALENDAR LOGIC ---
    let nav = 0; let clickedDate = null; let events = [];
    const calendarGrid = document.getElementById('calendarGrid');

    function fetchSheetEvents() {
        document.getElementById('calLoading').style.display = 'block';
        fetch(EVENTS_API).then(res => res.json()).then(data => {
            events = data.map(ev => ({ id: ev.Id, date: ev.Date, title: ev.Title, type: ev.Type }));
            document.getElementById('calLoading').style.display = 'none';
            loadCalendar(); 
        }).catch(err => { document.getElementById('calLoading').innerText = "Failed to load events."; });
    }
    
    function loadCalendar() {
        const dt = new Date();
        if (nav !== 0) dt.setMonth(new Date().getMonth() + nav);
        const month = dt.getMonth(); const year = dt.getFullYear();
        const firstDay = new Date(year, month, 1); const daysInMonth = new Date(year, month + 1, 0).getDate();
        const padding = firstDay.getDay();

        document.getElementById('monthYearDisplay').innerText = dt.toLocaleDateString('en-us', { month: 'long', year: 'numeric' });
        calendarGrid.innerHTML = '';
        ['S','M','T','W','T','F','S'].forEach(d => { const div = document.createElement('div'); div.classList.add('day-name'); div.innerText = d; calendarGrid.appendChild(div); });
        for(let i=0; i<padding; i++) { const div = document.createElement('div'); div.classList.add('calendar-day','padding'); calendarGrid.appendChild(div); }
        for(let i=1; i<=daysInMonth; i++) {
            const div = document.createElement('div'); div.classList.add('calendar-day');
            div.innerHTML = `<div class="day-number">${i}</div>`;
            const dateStr = `${month+1}/${i}/${year}`;
            const dayEvents = events.filter(e => e.date === dateStr);
            dayEvents.forEach(ev => {
                const badge = document.createElement('div');
                badge.className = `event-badge ${ev.type || 'badge-default'}`;
                badge.innerText = ev.title;
                badge.onclick = (e) => { e.stopPropagation(); openEventModal(dateStr, ev); };
                div.appendChild(badge);
            });
            div.onclick = () => openEventModal(dateStr, null);
            calendarGrid.appendChild(div);
        }
    }
    
    function changeMonth(d) { nav += d; loadCalendar(); }
    
    function openEventModal(dateStr, existingEvent) {
        clickedDate = dateStr; document.getElementById('eventDate').value = dateStr;
        const btnSave = document.getElementById('btnSaveEvent'); const btnDelete = document.getElementById('btnDeleteEvent');
        if (existingEvent) {
            document.getElementById('modalEventHeader').innerText = "Edit Event";
            document.getElementById('eventTitle').value = existingEvent.title;
            document.getElementById('sheetEventId').value = existingEvent.id; 
            document.getElementById('eventType').value = existingEvent.type || 'badge-default';
            btnDelete.style.display = 'block'; btnSave.innerText = "Update";
        } else {
            document.getElementById('modalEventHeader').innerText = "Add Event";
            document.getElementById('eventTitle').value = '';
            document.getElementById('sheetEventId').value = '';
            document.getElementById('eventType').value = 'badge-default';
            btnDelete.style.display = 'none'; btnSave.innerText = "Save";
        }
        document.getElementById('modal-add-event').style.display = 'flex';
    }

    function saveEvent() {
        const title = document.getElementById('eventTitle').value;
        const type = document.getElementById('eventType').value;
        const id = document.getElementById('sheetEventId').value;
        const btn = document.getElementById('btnSaveEvent');
        if (!title) return alert("Title required");
        btn.innerText = "Saving..."; btn.disabled = true;

        if (id) {
            fetch(`${EVENTS_API}/Id/${encodeURIComponent(id)}`, { method: "PATCH", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: { Title: title, Type: type } }) })
            .then(res => { closeModal('modal-add-event'); fetchSheetEvents(); btn.disabled = false; });
        } else {
            const newId = Date.now().toString(); 
            const newEvent = { Id: newId, Date: clickedDate, Title: title, Type: type };
            fetch(EVENTS_API, { method: "POST", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: newEvent }) })
            .then(res => { closeModal('modal-add-event'); fetchSheetEvents(); btn.disabled = false; btn.innerText = "Save"; });
        }
    }

    function deleteEvent() {
        const id = document.getElementById('sheetEventId').value;
        if(!id || !confirm("Delete this event?")) return;
        document.getElementById('btnDeleteEvent').innerText = "Deleting...";
        fetch(`${EVENTS_API}/Id/${encodeURIComponent(id)}`, { method: "DELETE" })
        .then(res => { closeModal('modal-add-event'); fetchSheetEvents(); document.getElementById('btnDeleteEvent').innerText = "Delete"; });
    }

    // --- 8. EMPLOYEE REQUESTS LOGIC (MANAGEMENT) ---
    function fetchRequests() {
        const container = document.getElementById('requestsContainer');
        const spinner = document.getElementById('reqSpinner');
        const noMsg = document.getElementById('noRequestsMsg');
        container.innerHTML = ''; container.appendChild(spinner); spinner.style.display = 'block'; noMsg.style.display = 'none';

        fetch(REQUESTS_API).then(res => res.json()).then(data => {
            spinner.style.display = 'none';
            const pendingReqs = data.filter(r => r.Status === "Pending");
            if (pendingReqs.length === 0) { noMsg.style.display = 'block'; return; }

            pendingReqs.forEach(req => {
                const card = document.createElement('div');
                card.className = 'req-card';
                card.innerHTML = `
                    <div class="req-info">
                        <h5>${req.Employee} <span style="font-weight:normal; font-size:0.9rem; color:#888;">(${req.Date})</span></h5>
                        <p><strong>${req.Title}</strong></p>
                        <div class="req-reason">"${req.Reason}"</div>
                    </div>
                    <div>
                        <button class="action-btn btn-approve" onclick="processRequest('${req.Id}', 'Approved')">Approve</button>
                        <button class="action-btn btn-deny" onclick="openDenyModal('${req.Id}')">Deny</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }).catch(err => { spinner.style.display = 'none'; container.innerHTML = '<p style="color:red; text-align:center">Error loading requests.</p>'; });
    }

    function processRequest(id, status, reason = "") {
        const updateUrl = `${REQUESTS_API}/Id/${encodeURIComponent(id)}`;
        const payload = { "Status": status, "Admin_Comment": reason };

        fetch(updateUrl, { method: "PATCH", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: payload }) })
        .then(res => {
            if(res.ok) { alert(`Request ${status}!`); closeModal('modal-deny-req'); fetchRequests(); }
            else { alert("Error updating request."); }
        });
    }

    let currentDenyId = null;
    function openDenyModal(id) { currentDenyId = id; document.getElementById('denyReason').value = ''; document.getElementById('modal-deny-req').style.display = 'flex'; }
    function submitDeny() { const reason = document.getElementById('denyReason').value; if(!reason) return alert("Provide a reason."); processRequest(currentDenyId, 'Denied', reason); }

    // --- 9. Utility ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // Initial Load
    fetchRequests();
</script>

</body>
</html>
